<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MovieMax</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/admin.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé¨</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="../../index.html" class="logo">MovieMax Admin</a>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="active">Dashboard</a></li>
                    <li class="nav-item"><a href="manage-movies.html">Movies</a></li>
                    <li class="nav-item"><a href="manage-shows.html">Shows</a></li>
                    <li class="nav-item"><a href="manage-bookings.html">Bookings</a></li>
                </ul>
            </nav>
            <div class="user-menu">
                <div class="user-info">
                    <span class="user-name"></span>
                    <button class="btn btn-secondary" onclick="auth.adminLogout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Header -->
<div class="admin-header">
    <div class="container">
        <h1 class="admin-title">Manage Movies</h1>
        <div class="container" style="margin: 1rem 0;">
    <button class="btn btn-success" onclick="showAddForm()">+ Add Movie</button>
</div>
    </div>
</div>

<!-- Add Movie Button (moved below header) -->


<!-- Content -->
<div class="admin-container">
    <div class="container">
        <!-- Add/Edit Movie Form -->
        <div class="content-section" id="movieFormSection" style="display:none;">
            <div class="section-header">
                <h2 class="section-title" id="formTitle">Add New Movie</h2>
                <div>
                    <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                </div>
            </div>
            <div class="section-body">
                <form class="admin-form" id="movieForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="movieName">Movie Name *</label>
                            <input type="text" class="form-control" id="movieName" required>
                        </div>
                        <div class="form-group">
                            <label for="movieGenre">Genre</label>
                            <select class="form-control" id="movieGenre">
                                <option value="">Select Genre</option>
                                <option value="Action">Action</option>
                                <option value="Comedy">Comedy</option>
                                <option value="Drama">Drama</option>
                                <option value="Horror">Horror</option>
                                <option value="Romance">Romance</option>
                                <option value="Sci-Fi">Sci-Fi</option>
                                <option value="Thriller">Thriller</option>
                                <option value="Fantasy">Fantasy</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="language">Language</label>
                            <select class="form-control" id="language">
                                <option value="">Select Language</option>
                                <option value="Hindi">Hindi</option>
                                <option value="English">English</option>
                                <option value="Telugu">Telugu</option>
                                <option value="Tamil">Tamil</option>
                                <option value="Kannada">Kannada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="movieHours">Duration (hours)</label>
                            <input type="number" class="form-control" id="movieHours" min="1" max="5" step="0.5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" rows="4" placeholder="Enter movie description..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Movie</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    </div>

                    <input type="hidden" id="editMovieId">
                </form>
            </div>
        </div>

        <!-- Movies List -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">All Movies</h2>
                <div class="admin-search">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="searchMovies" placeholder="Search movies..." onkeyup="filterMovies()">
                        <button class="search-button">üîç</button>
                    </div>
                </div>
            </div>
            <div class="section-body">
                <div id="moviesTable">
                    <!-- Movies table will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="../../config/app-config.js"></script>
<script src="../../assets/js/utils.js"></script>
<script src="../../assets/js/api.js"></script>
<script src="../../assets/js/auth.js"></script>

<script>
    let allMovies = [];
    let editingMovieId = null;

    document.addEventListener('DOMContentLoaded', function() {
        if (!auth.requireAdminLogin()) return;
        auth.updateNavigation();
        loadMovies();
        document.getElementById('movieForm').addEventListener('submit', handleFormSubmit);
    });

    async function loadMovies() {
        const tableContainer = document.getElementById('moviesTable');
        try {
            Utils.showLoading(tableContainer);
            allMovies = await api.getMovies();
            displayMovies(allMovies);
        } catch (error) {
            console.error('Error loading movies:', error);
            tableContainer.innerHTML = '<p class="text-center text-muted">Error loading movies</p>';
        }
    }

    function showAddForm() {
        document.getElementById('movieFormSection').style.display = 'block';
        document.getElementById('formTitle').textContent = 'Add New Movie';
        resetForm();
        editingMovieId = null;
    }

    function cancelEdit() {
        document.getElementById('movieFormSection').style.display = 'none';
        resetForm();
        editingMovieId = null;
    }

    function resetForm() {
        document.getElementById('movieForm').reset();
        document.getElementById('editMovieId').value = '';
    }

    function displayMovies(movies) {
        const tableContainer = document.getElementById('moviesTable');
        if (movies.length === 0) {
            tableContainer.innerHTML = '<p class="text-center text-muted">No movies found</p>';
            return;
        }
        const tableHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Genre</th>
                        <th>Language</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${movies.map(movie => `
                        <tr>
                            <td>${movie.movieId}</td>
                            <td>${movie.movieName}</td>
                            <td>${movie.movieGenre || '-'}</td>
                            <td>${movie.language || '-'}</td>
                            <td>${movie.movieHours || '-'}h</td>
                            <td>
                                <button class="btn btn-sm btn-edit" onclick="editMovie(${movie.movieId})">Edit</button>
                                <button class="btn btn-sm btn-delete" onclick="deleteMovie(${movie.movieId}, '${movie.movieName}')">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = tableHTML;
    }

    function editMovie(movieId) {
        const movie = allMovies.find(m => m.movieId === movieId);
        if (!movie) return;
        document.getElementById('movieFormSection').style.display = 'block';
        document.getElementById('formTitle').textContent = 'Edit Movie';
        document.getElementById('movieName').value = movie.movieName;
        document.getElementById('movieGenre').value = movie.movieGenre;
        document.getElementById('language').value = movie.language;
        document.getElementById('movieHours').value = movie.movieHours;
        document.getElementById('description').value = movie.description;
        document.getElementById('editMovieId').value = movieId;
        editingMovieId = movieId;
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const data = {
            movieName: document.getElementById('movieName').value,
            movieGenre: document.getElementById('movieGenre').value,
            language: document.getElementById('language').value,
            movieHours: parseFloat(document.getElementById('movieHours').value) || null,
            description: document.getElementById('description').value
        };
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = editingMovieId ? 'Updating...' : 'Adding...';
        try {
            if (editingMovieId) {
                await api.updateMovie(editingMovieId, data);
                Utils.showSuccess('Movie updated successfully!', document.querySelector('.section-body'));
            } else {
                await api.createMovie(data);
                Utils.showSuccess('Movie added successfully!', document.querySelector('.section-body'));
            }
            cancelEdit();
            loadMovies();
        } catch (err) {
            Utils.showError('Operation failed: ' + err.message, document.querySelector('.section-body'));
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save Movie';
        }
    }

    async function deleteMovie(id, name) {
        if (!confirm(`Delete "${name}"?`)) return;
        try {
            await api.deleteMovie(id);
            Utils.showSuccess('Movie deleted successfully!', document.getElementById('moviesTable'));
            loadMovies();
        } catch (err) {
            Utils.showError('Delete failed: ' + err.message, document.getElementById('moviesTable'));
        }
    }

    function filterMovies() {
        const term = document.getElementById('searchMovies').value.toLowerCase();
        const filtered = allMovies.filter(m =>
            m.movieName.toLowerCase().includes(term) ||
            (m.movieGenre || '').toLowerCase().includes(term) ||
            (m.language || '').toLowerCase().includes(term)
        );
        displayMovies(filtered);
    }
</script>

</body>
</html>